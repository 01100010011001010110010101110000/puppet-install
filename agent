EXPECTED_ARGS=1
E_BADARGS=65
OS_MAJ_VERSION=`rpm -qa \*-release | grep -Ei "oracle|redhat|centos" | cut -d"-" -f3`
 
if [ $# -ne $EXPECTED_ARGS ]
then
  echo "Usage: $0 master_hostname"
  exit $E_BADARGS
fi
 
MASTER_HOSTNAME=$1
 
yum install -y http://yum.puppetlabs.com/puppetlabs-release-el-$OS_MAJ_VERSION.noarch.rpm || true
yum -y install puppet
 
echo "[main]
logdir=/var/log/puppet
vardir=/var/lib/puppet
ssldir=/var/lib/puppet/ssl
rundir=/var/run/puppet
server=$MASTER_HOSTNAME
report=true
pluginsync=true
 
[master]
# These are needed when the puppetmaster is run by passenger
# and can safely be removed if webrick is used.
ssl_client_header = SSL_CLIENT_S_DN 
ssl_client_verify_header = SSL_CLIENT_VERIFY" > /etc/puppet/puppet.conf

puppet resource service puppet ensure=running enable=true
